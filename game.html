<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>سباق الحروف</title>
  <style>
    :root{
      --bg:#1f4fa3;
      --yellow:#f4c400;
      --card:#ffffff;
      --text:#111;
      --muted:#666;
      --green:#1aa34a;
      --orange:#f28c00;
      --red:#c01818;
      --pale:#f3e7a6;
    }
    body{margin:0;background:var(--bg);font-family:Arial, sans-serif;color:#fff;text-align:center}
    header{position:relative;padding:14px 14px 0}
    .logo{position:absolute;left:14px;top:14px;width:44px;height:44px;object-fit:contain}
    .gameName{position:absolute;right:14px;top:20px;font-size:14px;opacity:.95}
    h1{margin:18px 0 10px;color:var(--yellow);font-size:28px}
    .wrap{width:95%;max-width:900px;margin:0 auto}

    .card{
      background:var(--card);color:var(--text);
      width:100%;margin:12px auto;padding:12px;border-radius:12px;
      box-sizing:border-box
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;align-items:center}
    .btn{
      padding:12px 14px;font-size:16px;border:none;border-radius:10px;cursor:pointer
    }
    .btnYellow{background:var(--yellow);color:#000}
    .btnGreen{background:var(--green);color:#fff}
    .btnRed{background:var(--red);color:#fff}
    .btnOrange{background:var(--orange);color:#fff}

    .codeBox{font-size:18px}
    .codeNum{font-size:28px;font-weight:bold;letter-spacing:2px}

    .teams{display:flex;gap:10px;flex-wrap:wrap}
    .teamCol{flex:1;min-width:240px;border-radius:12px;padding:10px;color:#fff}
    .teamGreen{background:rgba(26,163,74,.9)}
    .teamOrange{background:rgba(242,140,0,.9)}
    .teamTitle{font-weight:bold;margin-bottom:8px}
    .playerItem{
      background:rgba(255,255,255,.18);
      padding:8px;border-radius:10px;margin:6px 0;cursor:pointer
    }

    /* MAP */
    .mapOuter{width:100%;display:flex;justify-content:center}
    .mapScale{
      width:min(92vw, 760px);
      transform:scale(var(--zoom, 1));
      transform-origin:center top;
    }
    .mapBox{
      position:relative;
      width:100%;
      aspect-ratio: 1536 / 873;
      border-radius:12px;
      overflow:hidden;
      background:#0000;
    }
    .mapBox img{width:100%;height:100%;object-fit:cover;display:block}

    .overlay{
      position:absolute;inset:0;
      pointer-events:none; /* نفعلها للمقدم من JS */
    }

    /* SVG hexes */
    #hexSvg{width:100%;height:100%;display:block}
    .hexPoly{cursor:pointer}
    .hexState0{fill:rgba(0,0,0,0)}
    .hexState1{fill:rgba(243,231,166,.75)}
    .hexState2{fill:rgba(26,163,74,.55)}
    .hexState3{fill:rgba(242,140,0,.55)}

    .below{
      display:flex;gap:10px;flex-wrap:wrap;justify-content:center;align-items:stretch
    }
    .buzzBox{
      min-width:260px;flex:1;
      border-radius:12px;padding:12px;color:#fff;
      display:flex;align-items:center;justify-content:center;font-size:18px
    }
    .buzzEmpty{background:rgba(0,0,0,.25)}
    .questionBox{
      min-width:260px;flex:2;
      border-radius:12px;padding:12px;background:#fff;color:#111;text-align:right
    }
    .qTitle{font-weight:bold;margin-bottom:8px}
    .qText{line-height:1.6}
    .smallNote{font-size:12px;opacity:.85;margin-top:8px}

    .playerBtnWrap{margin-top:14px}
    .playerBigBtn{
      width:min(92vw, 520px);
      height:110px;
      border:none;border-radius:18px;
      background:var(--red);
      cursor:pointer;
    }
    .disabled{opacity:.5;cursor:not-allowed}

    .footerBtn{
      width:100%;max-width:520px;margin:10px auto 18px;
      padding:14px;border:none;border-radius:12px;background:var(--yellow);cursor:pointer;color:#000;font-size:18px
    }
    a{color:inherit}
  </style>
</head>
<body>
  <header>
    <img class="logo" src="" alt="">
    <div id="gameName" class="gameName"></div>
    <h1>سباق الحروف</h1>
  </header>

  <div class="wrap">
    <div id="main" class="card">جاري التحميل...</div>
    <button class="footerBtn" onclick="location.href='index.html'">الرجوع للرئيسية</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getDatabase, ref, onValue, update, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDy2FEg8Xj0pA05syDawTh37rI1NEbQTjQ",
      authDomain: "sabaq-alhorof.firebaseapp.com",
      databaseURL: "https://sabaq-alhorof-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "sabaq-alhorof",
      storageBucket: "sabaq-alhorof.firebasestorage.app",
      messagingSenderId: "1053646928152",
      appId: "1:1053646928152:web:032d50148c3a4f1148066d"
    };

    const MAP_FILES = ["maps/map1.jpeg","maps/map2.jpeg","maps/map3.jpeg"];

    const MAPS = [
      [
        ["ذ","ج","أ","ب","ر"],
        ["ي","ح","ز","ل","س"],
        ["ث","ظ","ق","ض","ع"],
        ["ص","ن","د","ط","غ"],
        ["ك","خ","هـ","م","و"]
      ],
      [
        ["ق","ص","و","د","ب"],
        ["ح","ي","ض","هـ","ت"],
        ["ك","ط","ش","ز","م"],
        ["أ","ر","س","ظ","ث"],
        ["ذ","غ","هـ","ع","ج"]
      ],
      [
        ["ش","أ","ت","د","هـ"],
        ["ي","ح","ض","ن","ك"],
        ["غ","ظ","ق","ر","ع"],
        ["ص","ز","س","ط","و"],
        ["ذ","ل","ب","م","ج"]
      ]
    ];

    // أسئلة مؤقتة (بدّلها لاحقًا لما ترسل الـ PDF)
    const QUESTIONS = {};
    const ALL_LETTERS = Array.from(new Set(MAPS.flat(2)));
    for(const L of ALL_LETTERS){
      QUESTIONS[L] = [
        `سؤال 1 بحرف ${L}`,
        `سؤال 2 بحرف ${L}`,
        `سؤال 3 بحرف ${L}`
      ];
    }

    // هذه إطارات السداسيات مطابقة للصورة (نِسَب)
    // [x,y,w,h] لكل خلية (25) بترتيب 5x5
    const HEX_FRAMES = [
      [[0.126953,0.049255,0.136068,0.219931],[0.266276,0.049255,0.136068,0.219931],[0.405599,0.049255,0.136719,0.219931],[0.545573,0.049255,0.136068,0.219931],[0.684896,0.049255,0.136719,0.219931]],
      [[0.196615,0.218786,0.136068,0.219931],[0.335938,0.221077,0.135417,0.218786],[0.474609,0.219931,0.136068,0.219931],[0.613932,0.219931,0.136719,0.219931],[0.753906,0.219931,0.136068,0.219931]],
      [[0.127604,0.390607,0.136068,0.218786],[0.266276,0.390607,0.136068,0.218786],[0.405599,0.390607,0.136719,0.219931],[0.545573,0.390607,0.136068,0.219931],[0.684896,0.390607,0.136719,0.219931]],
      [[0.197266,0.560137,0.135417,0.219931],[0.335938,0.561283,0.136068,0.218786],[0.47526,0.561283,0.136719,0.218786],[0.615234,0.561283,0.136068,0.218786],[0.754557,0.561283,0.136719,0.219931]],
      [[0.126953,0.731959,0.136719,0.218786],[0.266276,0.733104,0.136068,0.218786],[0.404948,0.731959,0.136719,0.219931],[0.544922,0.731959,0.136719,0.219931],[0.684896,0.731959,0.136068,0.219931]]
    ];

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const params = new URLSearchParams(location.search);
    const role = params.get("role");
    const code = params.get("code");
    const hostKey = params.get("key");
    const pid = params.get("pid");

    const main = document.getElementById("main");
    const gameNameEl = document.getElementById("gameName");

    if(!role || !code){
      main.textContent = "بيانات الدخول غير مكتملة.";
      throw new Error("Missing params");
    }

    const roomRef = ref(db, `rooms/${code}`);

    function teamColor(team){
      return team === "green" ? "rgba(26,163,74,.9)" : "rgba(242,140,0,.9)";
    }

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    function cellKey(row,col){ return `${row}-${col}`; }

    function renderHostLobby(room){
      const players = room.players || {};
      const list = Object.entries(players).map(([id,p]) => ({id, ...p}));

      const green = list.filter(p => p.team === "green");
      const orange = list.filter(p => p.team === "orange");

      main.innerHTML = `
        <div class="codeBox">رمز اللعبة</div>
        <div class="codeNum">${escapeHtml(room.code)}</div>
        <div class="smallNote">شارك الرمز مع اللاعبين للدخول</div>

        <div style="height:12px"></div>

        <div class="teams">
          <div class="teamCol teamGreen">
            <div class="teamTitle">الفريق الأخضر</div>
            <div id="greenList"></div>
          </div>
          <div class="teamCol teamOrange">
            <div class="teamTitle">الفريق البرتقالي</div>
            <div id="orangeList"></div>
          </div>
        </div>

        <div style="height:12px"></div>

        <button id="startBtn" class="btn btnGreen">ابدأ اللعبة</button>
        <div class="smallNote">يمكنك الضغط على اسم لاعب لنقله للفريق الآخر</div>
      `;

      const greenList = document.getElementById("greenList");
      const orangeList = document.getElementById("orangeList");

      function draw(colEl, arr){
        colEl.innerHTML = arr.map(p => `<div class="playerItem" data-id="${escapeHtml(p.id)}">${escapeHtml(p.name)}</div>`).join("") || `<div class="smallNote">لا يوجد</div>`;
      }
      draw(greenList, green);
      draw(orangeList, orange);

      main.querySelectorAll(".playerItem").forEach(el => {
        el.addEventListener("click", async () => {
          const id = el.getAttribute("data-id");
          const p = players[id];
          if(!p) return;
          const newTeam = (p.team === "green") ? "orange" : "green";
          await update(ref(db, `rooms/${code}/players/${id}`), { team: newTeam });
        });
      });

      document.getElementById("startBtn").addEventListener("click", async () => {
        await update(roomRef, {
          status: "started",
          activeMap: 0,
          freeze: false,
          buzzer: null,
          current: { letter: null, qIndex: 0, row: null, col: null, map: 0 }
        });
      });
    }

    function renderWaiting(msg){
      main.innerHTML = `<div class="muted">${escapeHtml(msg)}</div>`;
    }

    function pointsFromFrame(x,y,w,h){
      // سداسي flat-top داخل إطار (x,y,w,h)
      const p = [
        [x + 0.25*w, y],
        [x + 0.75*w, y],
        [x + 1.00*w, y + 0.50*h],
        [x + 0.75*w, y + 1.00*h],
        [x + 0.25*w, y + 1.00*h],
        [x + 0.00*w, y + 0.50*h]
      ];
      return p.map(pt => pt.join(",")).join(" ");
    }

    function renderGame(room, me){
      gameNameEl.textContent = room?.name ? room.name : "";

      const isHost = role === "host";
      const started = room.status === "started";

      main.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <div style="font-size:14px;opacity:.9">رمز: <b>${escapeHtml(room.code)}</b></div>
          <div class="row">
            ${isHost ? `<button id="mapBtn" class="btn btnYellow">تغيير الخريطة</button>` : ""}
            <input id="zoom" type="range" min="0.8" max="1.35" step="0.01" value="1" />
            ${isHost ? `<button id="freezeBtn" class="btn ${room.freeze ? "btnRed" : "btnGreen"}">${room.freeze ? "مجمّد" : "مفعل"}</button>` : ""}
          </div>
        </div>

        <div class="mapOuter">
          <div id="mapScale" class="mapScale" style="--zoom:1">
            <div id="mapBox" class="mapBox">
              <img id="mapImg" src="" alt="">
              <div id="overlay" class="overlay">
                <svg id="hexSvg" viewBox="0 0 1 1" preserveAspectRatio="none"></svg>
              </div>
            </div>
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="below">
          <div id="buzzBox" class="buzzBox buzzEmpty">—</div>
          ${isHost ? `
            <div class="questionBox">
              <div class="qTitle">السؤال</div>
              <div id="qText" class="qText">اختر حرفًا من الخريطة</div>
            </div>
          ` : `
            <div class="questionBox">
              <div class="qTitle">الحالة</div>
              <div class="qText">${started ? "جاهز" : "بانتظار المقدم"}</div>
            </div>
          `}
        </div>

        ${isHost ? `
          <div style="height:10px"></div>
          <div class="row">
            <button id="nextQ" class="btn btnYellow">تغيير السؤال</button>
          </div>
        ` : ""}

        ${(!isHost) ? `
          <div class="playerBtnWrap">
            <button id="buzzBtn" class="playerBigBtn"></button>
            <div class="smallNote">${started ? "اضغط للإجابة" : "بانتظار بدء اللعبة"}</div>
          </div>
        ` : ""}
      `;

      const mapImg = document.getElementById("mapImg");
      const overlay = document.getElementById("overlay");
      const svg = document.getElementById("hexSvg");
      const mapScale = document.getElementById("mapScale");
      const zoom = document.getElementById("zoom");

      const activeMap = Number(room.activeMap || 0);
      mapImg.src = MAP_FILES[activeMap] || MAP_FILES[0];
      mapImg.onerror = () => { mapImg.src = MAP_FILES[0]; };

      // تفعيل الضغط للمقدم فقط
      overlay.style.pointerEvents = isHost ? "auto" : "none";

      // بناء السداسيات SVG
      svg.innerHTML = "";
      for(let r=0; r<5; r++){
        for(let c=0; c<5; c++){
          const [x,y,w,h] = HEX_FRAMES[r][c];
          const poly = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
          poly.setAttribute("points", pointsFromFrame(x,y,w,h));
          poly.setAttribute("data-row", String(r));
          poly.setAttribute("data-col", String(c));
          poly.setAttribute("class", "hexPoly hexState0");
          poly.style.pointerEvents = isHost ? "all" : "none"; // ضغط داخل السداسي فقط
          svg.appendChild(poly);
        }
      }

      // تطبيق حالات التلوين من قاعدة البيانات
      const mapStates = (room.mapStates && room.mapStates[String(activeMap)]) ? room.mapStates[String(activeMap)] : {};
      svg.querySelectorAll(".hexPoly").forEach(poly => {
        const r = Number(poly.getAttribute("data-row"));
        const c = Number(poly.getAttribute("data-col"));
        const k = cellKey(r,c);
        const st = Number(mapStates?.[k] ?? 0);
        poly.classList.remove("hexState0","hexState1","hexState2","hexState3");
        poly.classList.add(`hexState${st}`);
      });

      // عرض من ضغط أولًا
      const buzzBox = document.getElementById("buzzBox");
      const buzzer = room.buzzer;

      if(buzzer && buzzer.name){
        buzzBox.classList.remove("buzzEmpty");
        buzzBox.style.background = teamColor(buzzer.team);
        buzzBox.textContent = buzzer.name;
      }else{
        buzzBox.classList.add("buzzEmpty");
        buzzBox.style.background = "rgba(0,0,0,.25)";
        buzzBox.textContent = "—";
      }

      // السؤال للمقدم
      if(isHost){
        const qText = document.getElementById("qText");
        const cur = room.current || {};
        if(cur.letter){
          const list = QUESTIONS[cur.letter] || [];
          const idx = Number(cur.qIndex || 0) % Math.max(list.length,1);
          qText.textContent = list.length ? list[idx] : `لا يوجد سؤال لحرف ${cur.letter}`;
        }else{
          qText.textContent = "اختر حرفًا من الخريطة";
        }
      }

      // زوم
      zoom.addEventListener("input", () => {
        mapScale.style.setProperty("--zoom", zoom.value);
      });

      // تغيير الخريطة (مقدم فقط)
      const mapBtn = document.getElementById("mapBtn");
      if(mapBtn){
        mapBtn.addEventListener("click", async () => {
          const next = (activeMap + 1) % 3;
          await update(roomRef, {
            activeMap: next,
            buzzer: null,
            current: { letter: null, qIndex: 0, row: null, col: null, map: next }
          });
        });
      }

      // تجميد زر اللاعبين (مقدم فقط) + يمسح اسم الضاغط
      const freezeBtn = document.getElementById("freezeBtn");
      if(freezeBtn){
        freezeBtn.addEventListener("click", async () => {
          await update(roomRef, {
            freeze: !room.freeze,
            buzzer: null
          });
        });
      }

      // تغيير السؤال (مقدم فقط)
      const nextQ = document.getElementById("nextQ");
      if(nextQ){
        nextQ.addEventListener("click", async () => {
          const cur = room.current || {};
          if(!cur.letter) return;
          const list = QUESTIONS[cur.letter] || [];
          if(!list.length) return;
          const nextIndex = (Number(cur.qIndex || 0) + 1) % list.length;
          await update(roomRef, { current: { ...cur, qIndex: nextIndex } });
        });
      }

      // ضغط سداسي (مقدم فقط): يلوّن + يحدد حرف + يمسح البازر
      if(isHost){
        svg.querySelectorAll(".hexPoly").forEach(poly => {
          poly.addEventListener("click", async () => {
            if(room.status !== "started") return;

            const r = Number(poly.getAttribute("data-row"));
            const c = Number(poly.getAttribute("data-col"));
            const k = cellKey(r,c);

            const st = Number(mapStates?.[k] ?? 0);
            const next = (st + 1) % 4;

            const letter = MAPS[activeMap][r][c];

            const updates = {};
            updates[`rooms/${code}/mapStates/${activeMap}/${k}`] = next;
            updates[`rooms/${code}/buzzer`] = null;
            updates[`rooms/${code}/current`] = { letter, qIndex: 0, row: r, col: c, map: activeMap };

            await update(ref(db), updates);
          });
        });
      }

      // زر اللاعب الكبير (لاعب فقط)
      const buzzBtn = document.getElementById("buzzBtn");
      if(buzzBtn){
        const disabled = (!started) || room.freeze || !me || !me.name;
        if(disabled) buzzBtn.classList.add("disabled");

        buzzBtn.addEventListener("click", async () => {
          if(!started) return;
          if(room.freeze) return;
          if(!me) return;

          const buzzerRef = ref(db, `rooms/${code}/buzzer`);
          await runTransaction(buzzerRef, (cur) => {
            if(cur === null){
              return { pid, name: me.name, team: me.team, ts: Date.now() };
            }
            return;
          });
        });
      }
    }

    onValue(roomRef, (snap) => {
      if(!snap.exists()){
        main.textContent = "اللعبة غير موجودة (رمز غير صحيح).";
        return;
      }
      const room = snap.val();
      gameNameEl.textContent = room?.name ? room.name : "";

      if(role === "host"){
        if(!hostKey || hostKey !== room.presenterKey){
          main.textContent = "صلاحية المقدم غير صحيحة.";
          return;
        }
        if(room.status === "lobby"){
          renderHostLobby(room);
          return;
        }
        renderGame(room, null);
        return;
      }

      // لاعب
      const players = room.players || {};
      const me = pid ? players[pid] : null;

      if(!pid || !me){
        main.textContent = "بيانات اللاعب غير صحيحة.";
        return;
      }

      if(room.status === "lobby"){
        renderWaiting("بانتظار بدء اللعبة من المقدم...");
        return;
      }

      renderGame(room, me);
    });
  </script>
</body>
</html>
