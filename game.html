<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDy2FEg8Xj0pA05syDawTh37rI1NEbQTjQ",
    authDomain: "sabaq-alhorof.firebaseapp.com",
    projectId: "sabaq-alhorof",
    storageBucket: "sabaq-alhorof.firebasestorage.app",
    messagingSenderId: "1053646928152",
    appId: "1:1053646928152:web:032d50148c3a4f1148066d"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  function normalizeDigits(str) {
    const map = { "٠":"0","١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9" };
    return String(str).trim().replace(/[٠-٩]/g, d => map[d]);
  }

  async function createGame() {
    const btn = document.getElementById("btn");
    try {
      btn.disabled = true;
      btn.textContent = "جاري الإنشاء...";

      const name = document.getElementById("name").value.trim();
      const rawPlayers = document.getElementById("players").value;
      const players = Number(normalizeDigits(rawPlayers));

      if (!name || !Number.isFinite(players) || players <= 0) {
        alert("املأ جميع الحقول بشكل صحيح");
        return;
      }

      const docRef = await addDoc(collection(db, "games"), {
        name,
        players,
        createdAt: serverTimestamp()
      });

      // ✅ هذا هو السطر الصحيح
      location.href = game.html?id=${encodeURIComponent(docRef.id)};

    } catch (e) {
      alert("صار خطأ أثناء إنشاء اللعبة:\n" + (e?.message || e));
      console.error(e);
    } finally {
      btn.disabled = false;
      btn.textContent = "إنشاء";
    }
  }

  document.getElementById("btn").addEventListener("click", createGame);
</script>
